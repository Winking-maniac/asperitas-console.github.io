# Подготовка к развёртываниям с нуля

При первоначальном развёртывании строго советуется пройти каждый пункт! 
Asperitas Console не предполагает быстрого старта или прототипного развёртывания! 

Для запуска консоли введите команду в консоли узла развёртывания
~~~shell
asperitas
~~~

Для запуска консоли в режиме **debug** используйте команду 
~~~shell
asperitas --debug
~~~

После выполнения команды появляется **Главное окно** asperitas консоли
![Главное меню](/images/main-menu.png)

## Физические узлы 

Перейдите во вкладку _Baremetal nodes_. 
Нажмите кнопку _Add_, чтобы добавить новый физический узел для добавления в развёртываемое облако.

![](/images/baremetal-node-add.png)

Красным цветом выделены поля обязательные для заполнения.

* _Name_ -  имя физического узла. Используется лишь для удобства, не влияет на hostname узла;
* _BMC type_ - тип BMC, поддерживаемые значения: _IPMI_, _iDRAC_;
* _BMC address_ - IP-адрес BMC, пример: _2.3.4.5_ ;
* _BMC login_ - логин для управления физическим узлом через BMC;
* _BMC password_ - пароль для управления физическим узлом через BMC;
* _Profile_ - роль физического узла в развёртываемом облаке; 
* _UEFI boot mode_ - установите галочку, если узел загружается в режиме UEFI;
* _PXE port mac_address_ - мак адрес физического порта узла, через который происходит загрузке по PXE.

Поля необязательные для заполнения (используются, если интроспекция узла нежелательна):
* _Disk capacity_ - размер физического диска для установки операционной системы;
* _Cpu number_ - число процессорных ядер узла;
* _Architecture_ - архитектура процессора (поддерживается только x86_64);
* _Memory capacity_ - размер оперативной памяти узла.

Нажмите кнопку _Save_. Физический узел добавится в список физических узлов. 
При добавлении физического узла узел не включается и вводится в развёртываемое облако.

Дождитесь изменения статуса узла на _manageable/available_. 
Если узел остаётся в статусе enroll, перейдите в раздел "Исправление проблем". 

Статус _manageable_ позволяет включать и выключать узел из системы на узле развёртывания. 
Статус _available_ позволяет ввести машину в развёртываемое облако. 
Система автоматически переводит узел в состояние _available_, если известны параметры _Disk capacity_, _Cpu number_, _Architecure_ и _Memory capacity_.

## Интроспекция

Перейдите во вкладку _Introspection_ Главного меню. 

![](/images/introspection-list.png)

На экране отобразится список физических машин, добавленных в предыдущем пункте.

Отметьте весь список машин и нажмите кнопку _Start_. Начнётся интроспекция физических узлов. Статус отображается в правой половине экрана. 

После успешного окончания интроспекции напротив поле _state_ будет равно значению _finished_, а напротив имени узла появится галочка. 

Статус отображается только для одного узла. Чтобы посмотреть статус для другого узла, нажмите на имя узла. 

После успешной интроспекции можно посмотреть собранные данные дважды нажав мышкой на имя узла. Если мышки нет, то при помощи кнопок наведитесь на имя узла и нажмите _Enter_

![](/images/introspection-data.png)
 
## Порядок физических интерфейсов

_! Опция доступна только после успешной интроспекции_

Перейдите во вкладку _Network interfaces order_. 

![](/images/nics-order.png)

На экране отобразится список узлов и их интерфейсов. Порядок интерфейсов важен, так как далее сетевые планы строятся только по номерами интерфейсов, а не их именам. Поэтому определите порядок так, чтобы интерфейсы всех узлов с одним порядковым номером были настроены одинаково на физических коммутаторах в вашей серверной.  

## Диск операционной системы

_! Опция доступна только после успешной интроспекции_

Перейдите во вкладку _Server root disk_. 

![](/images/root-device.png)

Если у какого-либо физического узла несколько дисков, то необходимо указать правильный диск для установки операционной системы. 
Иначе система выберет физический диск случайным образом.  

## Физические порты 

Перейдите во вкладку _Baremetal ports_. 

![](/images/baremetal-ports.png)

Здесь отображаются все физические порты известные системе для загрузки по PXE. 
Первоначально создаётся порт указанный при создании физической машины. Затем после интроспекции добавляется порт, по которому произошла загрузка по PXE, 
**если этот порт не совпал с указанным вами при создании**. 

Если это произошло, то необходимо оставить один порт в системе и удалить ненужный! Иначе при развёртывании порт для загрузки будет выбран случайным образом из этих двух.  

## Сети

Перейдите во вкладку _Networks_. 

![](/images/networks.png)

В системе Asperitas используется принцип разделения сетей на роли. 
Набор заранее заданных сетей, который обязан присутствовать в системе: 

* _Ctlplane_ - сеть администрирования физических узлов в развёртываемом облаке. 
Это единственная сеть, по которой разрешён SSH доступ к физическим узлам облака. 
* _External_ - сеть для доступа к публичному API развёртываемого облака. 
Сеть должна быть доступна для всех пользователей облака. 
* _InternalApi_ - сеть для доступа к приватному API развёртываемого облака. 
Используется сервисами облака для общения друг с другом. 
Не должна быть доступна даже с узла развёртывания. 
* _Storage_ - сеть для доступа сервисов облака к хранилищу: Ceph или Nfs.

Набор заранее заданных опциональных сетей, их можно удалить из системы за ненадобностью:
* _InternalCeph_ - внутренняя сеть для узлов хранения Ceph.
* _IronicProvisioning_ - сеть для захвата физических узлов сервисом Ironic развёртываемого облака. 
Если сервис не используется, то сеть не нужна.  

Можно изменить параметры сети, нажав на сеть в списке сетей двумя кликами мыши или кнопной _Enter_.

![](/images/network-edit.png)

Если необходима дополнительная сеть, то можно добавить новую, нажав кнопку _Add_.

Если в поле _Exists_ стоит галочка, то сеть уже создана в системе и её нельзя удалить из списка сетей. 

Сеть создаётся при развёртывании в дальнейшем и удаляется, если удаляется развёртывание. 

## Шаблоны развёртывания 

Перейдите во вкладку _Deployment templates_. 

![](/images/templates.png)

При чистом старте - таблица будет пустая. Нажмите кнопку _Add_, чтобы добавить новое развёртывание. 

В появившемся окне вы можете выбрать один из заранее заданных типов развёртывания: _OpenStack_ или _Ceph_, или выбрать _No_.

Если OpenStack планируется развернуть **без Ceph**, то создайте единственное развёртывание типа _OpenStack_.

Если OpenStack планируется развернуть **с Ceph**, то создайте сначала развёртывание _Ceph_, затем _OpenStack_

![](/images/templates-add-2.png)

Заполните имя развёртывания в поле _Name_. Имя будет использоваться как часть hostname физических узлов.

В поле _Images Path_ из выпадающего списке выберите образ операционной системы, используемой для развёртывания. 
Как правило для типа _Ceph_ используются образы _images-ceph_, а для типа _OpenStack_ используются образы _images-asperitas_. 
Если ваш путь к образам отличается от тех, что даются на выбор, то поставьте галочку в поле _set if custom image is used_ и укажите путь к образам в поле ниже. 

На данном этапе при создании развёртывания создаются только шаблоны для настройки развёртываемого облака. 
Никаких изменений с физическими машинами не происходит.

На главном экране asperitas консоли в секции _Deployments_ появятся ваши созданные развёртывания для настройки. 
